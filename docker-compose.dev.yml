version: '3.8'

services:
  # ResilientDB Database
  # Note: Using existing ResilientDB setup from start-resilientdb.sh
  # This service is optional if ResilientDB is already running
  resilientdb:
    image: expolab/resdb:${ARCH:-amd64}
    platform: linux/arm64
    container_name: resilientdb
    ports:
      - "18000:18000"
      - "5001:5001"  # GraphQL server port
    volumes:
      - resilientdb-data:/data
      # Mount GraphQL setup script for persistence
      - ./setup-graphql.sh:/app/setup-graphql.sh:ro
    networks:
      - graphq-llm-network
    environment:
      - RESDB_HOST=0.0.0.0
      - RESDB_PORT=18000
    # IMPORTANT: The expolab/resdb image's default entrypoint starts ResilientDB KV service
    # We need to preserve that behavior while also setting up GraphQL
    # Option 1: Don't override command (let image start KV, then manually run setup-graphql.sh)
    # Option 2: Explicitly start KV service, then GraphQL
    # 
    # For now, we assume the image starts KV service automatically via its entrypoint
    # If it doesn't, we may need to check the image's documentation or entrypoint
    # 
    # The healthcheck tests port 18000 (KV service), confirming it's running
    # If healthcheck fails, the KV service isn't starting - check image entrypoint
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      # The expolab/resdb image should start ResilientDB KV service via its default entrypoint
      # If the image doesn't have a default entrypoint that starts KV service, we need to start it here
      # For now, we assume KV service starts automatically (check logs if healthcheck fails)
      # 
      # Start GraphQL setup (this runs after container starts)
      chmod +x /app/setup-graphql.sh && 
      /app/setup-graphql.sh
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:18000/v1/transactions/test || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s  # Increased to allow GraphQL setup time (first run takes longer)

  # GraphQ-LLM Backend (Node.js/TypeScript)
  graphq-llm-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: graphq-llm-backend
    ports:
      - "3001:3001"
      - "9229:9229" # Debug port
    environment:
      # ResilientDB Configuration
      - RESILIENTDB_GRAPHQL_URL=${RESILIENTDB_GRAPHQL_URL:-http://resilientdb:5001/graphql}
      - RESILIENTDB_API_KEY=${RESILIENTDB_API_KEY:-}
      
      # Nexus Configuration (optional)
      - NEXUS_API_URL=${NEXUS_API_URL:-}
      - NEXUS_API_KEY=${NEXUS_API_KEY:-}
      
      # ResLens Configuration (for Live Mode)
      - RESLENS_API_URL=${RESLENS_API_URL:-}
      - RESLENS_API_KEY=${RESLENS_API_KEY:-}
      - RESLENS_LIVE_MODE=${RESLENS_LIVE_MODE:-false}
      - RESLENS_POLL_INTERVAL=${RESLENS_POLL_INTERVAL:-5000}
      
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-deepseek}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-deepseek-chat}
      # Enable Live Stats access for LLM (requires ResLens Live Mode)
      - LLM_ENABLE_LIVE_STATS=${LLM_ENABLE_LIVE_STATS:-false}
      
      # Embedding Provider Configuration (Hugging Face)
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY:-}
      
      # MCP Server Configuration
      - MCP_SERVER_PORT=3001
      - MCP_SERVER_HOST=0.0.0.0
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=development
      
      # Debug
      - NODE_OPTIONS=--inspect=0.0.0.0:9229
    depends_on:
      resilientdb:
        condition: service_healthy
    networks:
      - graphq-llm-network
    volumes:
      # Live updates: mount source code
      - ./src:/app/src
      - ./dist:/app/dist
      - ./package.json:/app/package.json
      - ./tsconfig.json:/app/tsconfig.json
      # Mount docs directory for document ingestion
      - ./docs:/app/docs
      # Exclude node_modules from volume mount
      - /app/node_modules
    command: npm run dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ResLens Middleware (Optional - for live performance monitoring)
  # Uncomment and configure when ResLens Middleware is available
  # See RESLENS_DOCKER_SETUP.md for full setup instructions
  #
  # reslens-middleware:
  #   image: # ResLens Middleware image from https://github.com/apache/incubator-resilientdb-ResLens-Middleware
  #   container_name: reslens-middleware
  #   ports:
  #     - "4040:4040"  # Pyroscope UI
  #     - "9256:9256"  # Process Exporter metrics
  #     - "8080:8080"  # Middleware HTTP API (adjust port as needed)
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   networks:
  #     - graphq-llm-network
  #   environment:
  #     - RESDB_HOST=resilientdb
  #     - RESDB_PORT=18000
  #   depends_on:
  #     resilientdb:
  #       condition: service_healthy
  #   # Note: Requires elevated privileges for eBPF profiling
  #   # privileged: true  # Uncomment if needed for Pyroscope

networks:
  graphq-llm-network:
    driver: bridge
    name: graphq-llm-network

volumes:
  resilientdb-data:
    name: resilientdb-data

