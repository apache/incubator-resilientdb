{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 60, "column": 0}, "map": {"version":3,"sources":["file:///Users/sandhya/UCD/ECS_DDS/graphq-llm/nexus/src/app/api/graphql-tutor/analyze/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\n/**\n * GraphQ-LLM Analysis API\n * Proxies requests to GraphQ-LLM backend for full query analysis\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const { query } = await req.json();\n\n    if (!query || typeof query !== \"string\") {\n      return NextResponse.json(\n        { error: \"Query is required\" },\n        { status: 400 }\n      );\n    }\n\n    // GraphQ-LLM backend URL (from environment or default)\n    const graphqLlmUrl = process.env.GRAPHQ_LLM_API_URL || \n                        process.env.NEXT_PUBLIC_GRAPHQ_LLM_API_URL || \n                        \"http://localhost:3001\";\n\n    try {\n      // Call GraphQ-LLM explanation service\n      const explainResponse = await fetch(`${graphqLlmUrl}/api/explanations/explain`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ query, detailed: true }),\n      });\n\n      // Call GraphQ-LLM optimization service\n      const optimizeResponse = await fetch(`${graphqLlmUrl}/api/optimizations/optimize`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ query, includeSimilarQueries: true }),\n      });\n\n      // Call GraphQ-LLM efficiency service\n      const efficiencyResponse = await fetch(`${graphqLlmUrl}/api/efficiency/estimate`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ query, useLiveStats: false }),\n      });\n\n      // Parse responses\n      const explanationData = explainResponse.ok ? await explainResponse.json() : null;\n      const optimizationData = optimizeResponse.ok ? await optimizeResponse.json() : null;\n      const efficiencyData = efficiencyResponse.ok ? await efficiencyResponse.json() : null;\n\n      // Format explanation response for UI\n      const explanation = explanationData\n        ? {\n            explanation: explanationData.explanation || \"No explanation available\",\n            complexity: explanationData.complexity || \"medium\",\n            recommendations: explanationData.recommendations || [],\n          }\n        : {\n            explanation: \"Explanation service unavailable. Please ensure GraphQ-LLM backend is running.\",\n            complexity: \"unknown\",\n            recommendations: [],\n          };\n\n      // Format optimizations response for UI\n      const optimizations = optimizationData?.suggestions\n        ? optimizationData.suggestions.map((s: any) => ({\n            query: s.optimizedQuery || query,\n            explanation: s.reason || s.suggestion || \"Optimization suggestion\",\n            confidence: 0.8,\n          }))\n        : [];\n\n      // Format efficiency response for UI\n      // Extract complexity from efficiencyData or fallback to explanationData\n      const complexity = efficiencyData?.complexity || \n                        explanationData?.complexity || \n                        (efficiencyData?.queryAnalysis ? \n                          (efficiencyData.queryAnalysis.fieldCount > 20 ? \"high\" : \n                           efficiencyData.queryAnalysis.fieldCount > 10 ? \"medium\" : \"low\") : \n                          \"medium\");\n\n      const efficiency = efficiencyData\n        ? {\n            score: efficiencyData.efficiencyScore || 0,\n            estimatedTime: efficiencyData.estimatedExecutionTime\n              ? `${efficiencyData.estimatedExecutionTime}ms`\n              : \"Unknown\",\n            resourceUsage: efficiencyData.estimatedResourceUsage\n              ? `CPU: ${efficiencyData.estimatedResourceUsage.cpu || \"N/A\"}%, Memory: ${efficiencyData.estimatedResourceUsage.memory || \"N/A\"}MB`\n              : \"Unknown\",\n            recommendations: efficiencyData.recommendations || [],\n            complexity: complexity, // Use extracted complexity\n            similarQueries: efficiencyData.similarQueries,\n          }\n        : {\n            score: 0,\n            estimatedTime: \"Unknown\",\n            resourceUsage: \"Unknown\",\n            recommendations: [],\n            complexity: complexity, // Use extracted complexity even in fallback\n          };\n\n      // Send query statistics to ResLens Middleware\n      const middlewareUrl = process.env.RESLENS_MIDDLEWARE_URL || \"http://localhost:3003\";\n      const storeUrl = `${middlewareUrl}/api/v1/queryStats/store`;\n      \n      try {\n        console.log(`[Nexus] Sending query stats to middleware: ${storeUrl}`);\n        console.log(`[Nexus] Efficiency complexity: ${efficiency.complexity}`);\n        const middlewareResponse = await fetch(storeUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            query,\n            efficiency: {\n              ...efficiency,\n              complexity: efficiency.complexity || \"medium\", // Ensure complexity is always set\n            },\n            explanation,\n            optimizations,\n            timestamp: new Date().toISOString(),\n          }),\n        });\n\n        if (!middlewareResponse.ok) {\n          const errorText = await middlewareResponse.text().catch(() => 'Unknown error');\n          console.error(`[Nexus] Middleware returned ${middlewareResponse.status}: ${errorText}`);\n        } else {\n          const result = await middlewareResponse.json().catch(() => ({}));\n          console.log(`[Nexus] Query stats stored successfully:`, result);\n        }\n      } catch (middlewareError) {\n        // Log but don't fail if middleware is unavailable\n        console.error(\"[Nexus] Failed to store query statistics in middleware:\", middlewareError);\n        if (middlewareError instanceof Error) {\n          console.error(\"[Nexus] Error details:\", middlewareError.message);\n          console.error(\"[Nexus] Stack:\", middlewareError.stack);\n        }\n      }\n\n      return NextResponse.json({\n        explanation,\n        optimizations,\n        efficiency,\n      });\n    } catch (fetchError) {\n      // Fallback to mock data if GraphQ-LLM backend is not available\n      console.warn(\"GraphQ-LLM backend not available, using fallback:\", fetchError);\n      \n      return NextResponse.json({\n        explanation: {\n          explanation: `This query retrieves transaction data from ResilientDB. The query structure suggests it's fetching a single transaction by ID.`,\n          complexity: \"low\",\n          recommendations: [\n            \"Consider adding pagination for large result sets\",\n            \"Use specific field selections to reduce payload size\",\n          ],\n        },\n        optimizations: [\n          {\n            query: query,\n            explanation: \"Query is already well-optimized for single transaction retrieval.\",\n            confidence: 0.85,\n          },\n        ],\n        efficiency: {\n          score: 92,\n          estimatedTime: \"< 10ms\",\n          resourceUsage: \"Low - Single transaction lookup\",\n          recommendations: [\n            \"Query is efficient for single transaction retrieval\",\n          ],\n        },\n      });\n    }\n  } catch (error) {\n    console.error(\"Error analyzing query:\", error);\n    return NextResponse.json(\n      { error: \"Failed to analyze query\" },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}