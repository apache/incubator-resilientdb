#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

name: Deploy Ecosystem Projects to Vercel

on:
  push:
    branches:
      - development
    paths:
      - 'ecosystem/**'
      - '.github/workflows/deploy-ecosystem.yml'
      - '.github/deploy-ecosystem-configs.json'
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Specific project to deploy (leave empty to deploy all changed projects)'
        required: false
        type: string
      force_deploy_all:
        description: 'Force deploy all projects regardless of changes'
        required: false
        type: boolean
        default: false

jobs:
  determine-projects:
    name: Determine Projects to Deploy
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.filter.outputs.projects }}
      projects_json: ${{ steps.filter.outputs.projects_json }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read deployment config
        id: config
        shell: bash
        run: |
          # Read JSON config file and output as multiline string
          echo "config_json<<EOF" >> "$GITHUB_OUTPUT"
          cat .github/deploy-ecosystem-configs.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Filter projects based on inputs
        id: filter
        shell: bash
        run: |
          # Read config JSON
          CONFIG_JSON="${{ steps.config.outputs.config_json }}"
          
          # Manual trigger: deploy specific project or all
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ inputs.project_name }}" ]; then
              # Find specific project using jq
              PROJECT=$(echo "$CONFIG_JSON" | jq -r --arg name "${{ inputs.project_name }}" '.projects[] | select(.name == $name)')
              if [ -n "$PROJECT" ] && [ "$PROJECT" != "null" ]; then
                echo "projects_json=[$PROJECT]" >> "$GITHUB_OUTPUT"
                echo "projects=[\"${{ inputs.project_name }}\"]" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
            if [ "${{ inputs.force_deploy_all }}" == "true" ]; then
              echo "projects_json=$(echo "$CONFIG_JSON" | jq -c '.projects')" >> "$GITHUB_OUTPUT"
              echo "projects=$(echo "$CONFIG_JSON" | jq -c '[.projects[].name]')" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          
          # For push events or default, deploy all projects
          echo "projects_json=$(echo "$CONFIG_JSON" | jq -c '.projects')" >> "$GITHUB_OUTPUT"
          echo "projects=$(echo "$CONFIG_JSON" | jq -c '[.projects[].name]')" >> "$GITHUB_OUTPUT"

      - name: Show projects to deploy
        run: |
          echo "Projects to deploy: ${{ steps.filter.outputs.projects }}"
          if [ "${{ steps.filter.outputs.projects }}" == "[]" ]; then
            echo "No projects to deploy"
          fi

  deploy:
    name: Deploy ${{ matrix.project.name }}
    needs: determine-projects
    if: needs.determine-projects.outputs.projects != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.determine-projects.outputs.projects_json) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
            **/npm-shrinkwrap.json
            **/yarn.lock
            **/pnpm-lock.yaml

      - name: Enable Corepack (for pnpm/yarn if needed)
        run: corepack enable

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install dependencies
        working-directory: ${{ matrix.project.path }}
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found, using npm install"
            npm install
          fi

      - name: Pull Vercel Environment Information
        working-directory: ${{ matrix.project.path }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ matrix.project.vercel_org_id || secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ matrix.project.vercel_project_id }}
        run: |
          if [ -n "$VERCEL_PROJECT_ID" ] && [ -n "$VERCEL_ORG_ID" ]; then
            mkdir -p .vercel
            echo "$VERCEL_ORG_ID" > .vercel/org-id
            echo "$VERCEL_PROJECT_ID" > .vercel/project-id
          fi

          vercel pull --yes --environment=production --token=$VERCEL_TOKEN || echo "Could not pull Vercel config, continuing..."

      - name: Build Project
        working-directory: ${{ matrix.project.path }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: vercel build --prod --token=$VERCEL_TOKEN

      - name: Deploy to Vercel
        working-directory: ${{ matrix.project.path }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment: ${{ matrix.project.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path:** ${{ matrix.project.path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
